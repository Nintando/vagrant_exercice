Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"
  config.vm.box_check_update = false

  config.vm.define "willS" do |server|
    server.vm.hostname = "willS"
    server.vm.network "private_network", ip: "192.168.56.110"

    server.vm.provider "virtualbox" do |vb|
      vb.name = "willS"
      vb.memory = 1024
      vb.cpus = 1
    end

    server.vm.provision "shell", privileged: true, inline: <<-SHELL
      apt-get update -y
      apt-get install -y curl netcat
      curl -sfL https://get.k3s.io/ | sh -s - server --write-kubeconfig-mode 644
      for i in $(seq 1 20); do
        if [ -f /var/lib/rancher/k3s/server/node-token ]; then break; fi
        sleep 2
      done
      cp /var/lib/rancher/k3s/server/node-token /vagrant/k3s_token
      cp /etc/rancher/k3s/k3s.yaml /vagrant/kubeconfig
      sed -i 's/127.0.0.1/192.168.56.110/g' /vagrant/kubeconfig || true
    SHELL
  end

  config.vm.define "willSW" do |worker|
    worker.vm.hostname = "willSW"
    worker.vm.network "private_network", ip: "192.168.56.111"

    worker.vm.provider "virtualbox" do |vb|
      vb.name = "willSW"
      vb.memory = 1024
      vb.cpus = 1
    end

    worker.vm.provision "shell", privileged: true, inline: <<-SHELL
      apt-get update -y
      apt-get install -y curl netcat
      for i in $(seq 1 20); do
        if [ -f /vagrant/k3s_token ] && nc -z 192.168.56.110 6443; then break; fi
        sleep 2
      done
      K3S_URL="https://192.168.56.110:6443/"
      K3S_TOKEN=$(cat /vagrant/k3s_token)
      curl -sfL https://get.k3s.io/ | K3S_URL=$K3S_URL K3S_TOKEN=$K3S_TOKEN sh -
      mkdir -p /home/vagrant/.kube
      cp /vagrant/kubeconfig /home/vagrant/.kube/config
      chown -R vagrant:vagrant /home/vagrant/.kube
      echo "alias k=kubectl" >> /home/vagrant/.bashrc
    SHELL
  end
end
